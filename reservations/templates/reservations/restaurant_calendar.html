{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Shotgun</title>
    <link rel="stylesheet" href="{% static 'reservations/styles.css' %}">
</head>
<body>
<div class="container">
    <h1 class="text-3xl font-light mb-6 text-center">Shotgun</h1>

    <!-- Subheading with Arrows and Date -->
    <div class="flex justify-center items-center mb-4">
        <!-- Left Arrow -->
        <button id="prevDay" class="text-2xl px-4">&larr;</button>

        <!-- Subheading with Dynamic Date -->
        <h2 class="text-xl font-medium mx-4 cursor-pointer" id="subHeadingDate">
            Schedule for {{ selected_date|date:"d. F Y" }}
        </h2>

        <!-- Right Arrow -->
        <button id="nextDay" class="text-2xl px-4">&rarr;</button>
    </div>

    <!-- Hidden Date Picker Form (linked to the subheading) -->
    <form id="datePickerForm" method="get" action="{% url 'restaurant_calendar' %}" style="display: none;">
        <input type="date" id="datePickerInput" name="date" value="{{ selected_date }}">
    </form>

    <div class="grid" id="calendarGrid">
        <!-- The grid will be populated by JavaScript -->
    </div>
</div>

<!-- Modal -->
<div id="reservationModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 class="text-xl font-medium mb-2">Reservation Details</h2>
        <p><strong>Name:</strong> <span id="resName"></span></p>
        <p><strong>Table(s):</strong> <span id="resTables"></span></p>
        <p><strong>Time:</strong> <span id="resTime"></span></p>
    </div>
</div>

<script>
    const tables = {{ tables|safe }};
    const timeSlots = {{ time_slots|safe }};
    const reservations = {{ reservations|safe }};

    const calendarGrid = document.getElementById('calendarGrid');

    // Build grid-template-columns dynamically
    calendarGrid.style.gridTemplateColumns = `auto repeat(${tables.length}, 1fr)`;

    // Table Headers
    const emptyHeader = document.createElement('div');
    emptyHeader.classList.add('sticky', 'left-0', 'bg-gray-100');
    calendarGrid.appendChild(emptyHeader);

    tables.forEach(table => {
        const tableHeader = document.createElement('div');
        tableHeader.classList.add('text-center', 'font-medium', 'py-2');
        tableHeader.textContent = `Table ${table.number}`;
        calendarGrid.appendChild(tableHeader);
    });

    // Time Slots and Cells
    timeSlots.forEach(timeStr => {
        const timeCell = document.createElement('div');
        timeCell.classList.add('sticky', 'left-0', 'bg-gray-100', 'pr-2', 'text-right', 'text-sm', 'py-2');
        timeCell.textContent = timeStr;
        calendarGrid.appendChild(timeCell);

        tables.forEach(table => {
            const cell = document.createElement('div');
            cell.classList.add('border', 'border-gray-200', 'bg-white');
            const reservation = getReservationForSlot(table.number, timeStr);

            if (reservation) {
                cell.classList.add('bg-blue-100');
                if (isSameMinute(new Date(reservation.start_datetime), timeStr)) {
                    cell.classList.add('rounded-t-md');
                    const resName = document.createElement('div');
                    resName.classList.add('text-xs', 'p-1', 'truncate');
                    resName.textContent = reservation.guest__name;
                    cell.appendChild(resName);
                }
                cell.addEventListener('click', () => showReservationDetails(reservation.id));
            }

            calendarGrid.appendChild(cell);
        });
    });

    function getReservationForSlot(tableNumber, time) {
        return reservations.find(res => 
            res.tables__number == tableNumber && 
            time === new Date(res.start_datetime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
        );
    }

    function isSameMinute(date1, timeStr) {
        return date1.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }) === timeStr;
    }

    function showReservationDetails(resId) {
        const reservation = reservations.find(res => res.id === resId);
        if (reservation) {
            document.getElementById('resName').textContent = reservation.guest__name;
            document.getElementById('resTables').textContent = reservation.tables__number;
            const startTime = new Date(reservation.start_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const endTime = new Date(reservation.end_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('resTime').textContent = `${startTime} - ${endTime}`;
            document.getElementById('reservationModal').style.display = 'block';
        }
    }

    function closeModal() {
        document.getElementById('reservationModal').style.display = 'none';
    }

    // Get references to important elements
    const subHeadingDate = document.getElementById('subHeadingDate');
    const prevDayButton = document.getElementById('prevDay');
    const nextDayButton = document.getElementById('nextDay');
    const datePickerInput = document.getElementById('datePickerInput');
    const datePickerForm = document.getElementById('datePickerForm');

    // Function to format date as YYYY-MM-DD
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    // Event handler for left/right arrows
    function changeDate(daysToAdd) {
        const currentDate = new Date(datePickerInput.value);
        currentDate.setDate(currentDate.getDate() + daysToAdd); // Move days
        datePickerInput.value = formatDate(currentDate); // Update hidden input
        datePickerForm.submit(); // Submit form
    }

    // Left arrow (previous day)
    prevDayButton.addEventListener('click', () => changeDate(-1));

    // Right arrow (next day)
    nextDayButton.addEventListener('click', () => changeDate(1));

    // Click on subheading to open date picker
    subHeadingDate.addEventListener('click', () => datePickerInput.click());

    // When a new date is selected from the date picker, submit the form
    datePickerInput.addEventListener('change', () => datePickerForm.submit());

</script>
</body>
</html>