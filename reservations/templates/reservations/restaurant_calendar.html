{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shotgun</title>
    <!-- Main styles for the calendar -->
    <link rel="stylesheet" href="{% static 'reservations/styles.css' %}">
    <!-- Header-specific styles -->
    <link rel="stylesheet" href="{% static 'reservations/header_styles.css' %}">
</head>
<body>

<!-- Header Section -->
<div class="header-container">
    <!-- Thumbnail / Icon (Optional) -->
    <div class="header-thumbnail">
        <img src="{% static 'reservations/AppIcon.png' %}" alt="Logo" class="header-logo">
    </div>

    <!-- Date Navigation Section -->
    <div class="date-navigation-container">
        <!-- Left Arrow -->
        <button id="prevDay" class="date-nav-arrow">&#9664;</button>
        
        <!-- Selected Date -->
        <span class="selected-date">{{ selected_date }}</span>
        
        <!-- Right Arrow -->
        <button id="nextDay" class="date-nav-arrow">&#9654;</button>
    </div>

    <!-- Action Buttons -->
    <div class="header-actions">
        <button class="primary-action">Add Reservation</button>
        <button class="secondary-action">Settings</button>
    </div>
</div>

<!-- Main Content Section (Calendar) -->
<div class="container">
    <div class="grid" id="calendarGrid">
        <!-- The grid will be populated by JavaScript -->
    </div>
</div>

<!-- Modal for reservation details -->
<div id="reservationModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 class="text-xl font-medium mb-2">Reservation Details</h2>
        <p><strong>Name:</strong> <span id="resName"></span></p>
        <p><strong>Table(s):</strong> <span id="resTables"></span></p>
        <p><strong>Time:</strong> <span id="resTime"></span></p>
    </div>
</div>

<!-- Calendar Pop-up Modal -->
<div id="calendarModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" id="closeModalBtn">&times;</span>
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prevMonth" class="arrow">&#9664;</button>
                <span id="calendarMonthYear" class="calendar-month-year">February 2024</span>
                <button id="nextMonth" class="arrow">&#9654;</button>
            </div>
            <table id="calendarTable" class="calendar-table">
                <!-- Calendar will be dynamically generated here -->
            </table>
        </div>
    </div>
</div>

<script>
    const tables = {{ tables|safe }};
    const timeSlots = {{ time_slots|safe }};
    const reservations = {{ reservations|safe }};
    const selectedDate = new Date("{{ selected_date }}");

    const calendarGrid = document.getElementById('calendarGrid');
    const prevDayButton = document.getElementById('prevDay');
    const nextDayButton = document.getElementById('nextDay');
    const dateSpan = document.querySelector('.selected-date'); // Corrected ID selector

    console.log("Tables:", tables);
    console.log("Time Slots:", timeSlots);
    console.log("Reservations:", reservations);

    // Centralize the date and arrows horizontally
    document.querySelector('.date-navigation-container').style.display = 'flex';
    document.querySelector('.date-navigation-container').style.justifyContent = 'center';
    document.querySelector('.date-navigation-container').style.alignItems = 'center';
    document.querySelector('.date-navigation-container').style.gap = '10px';

    // Event listeners to change the date
    prevDayButton.addEventListener('click', () => changeDate(-1));
    nextDayButton.addEventListener('click', () => changeDate(1));

    // Function to change the date
    function changeDate(days) {
        const newDate = new Date(selectedDate);
        newDate.setDate(newDate.getDate() + days);
        const formattedDate = newDate.toISOString().split('T')[0];
        window.location.href = `?date=${formattedDate}`;
    }

    // Populating the calendar grid
    calendarGrid.style.gridTemplateColumns = `auto repeat(${tables.length}, minmax(100px, 1fr))`; // Updated grid

    // Table Headers
    const emptyHeader = document.createElement('div');
    emptyHeader.classList.add('sticky', 'left-0', 'bg-gray-100');
    calendarGrid.appendChild(emptyHeader);

    tables.forEach(table => {
        const tableHeader = document.createElement('div');
        tableHeader.classList.add('text-center', 'font-medium', 'py-2');
        tableHeader.textContent = `Table ${table.number}`;
        calendarGrid.appendChild(tableHeader);
    });

    // Time Slots and Cells
    timeSlots.forEach(timeStr => {
        const time = new Date(`1970-01-01T${timeStr}:00`);

        // Only display the time label for full-hour times
        const timeCell = document.createElement('div');
        if (time.getMinutes() === 0) {
            timeCell.classList.add('sticky', 'left-0', 'bg-gray-100', 'pr-2', 'text-right', 'text-sm', 'py-2', 'time-cell');
            timeCell.textContent = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else {
            // Create an empty cell for half-hour intervals (no label, but same height)
            timeCell.classList.add('sticky', 'left-0', 'bg-gray-100', 'pr-2', 'text-sm', 'py-2', 'empty-time-cell');
        }
        calendarGrid.appendChild(timeCell);

        // Populate table cells for each time slot
        tables.forEach(table => {
            const cell = document.createElement('div');
            cell.classList.add('border', 'border-gray-200', 'bg-white');
            const reservation = getReservationForSlot(table.number, timeStr);

            if (reservation) {
                cell.classList.add('bg-blue-100');
                if (isSameMinute(new Date(reservation.start_datetime), timeStr)) {
                    cell.classList.add('rounded-t-md');
                    const resName = document.createElement('div');
                    resName.classList.add('text-xs', 'p-1', 'truncate');
                    resName.textContent = reservation.guest__name;
                    cell.appendChild(resName);
                }
                cell.addEventListener('click', () => showReservationDetails(reservation.id));
            }

            calendarGrid.appendChild(cell);
        });
    });

    function getReservationForSlot(tableNumber, time) {
        return reservations.find(res =>
            res.tables__number == tableNumber &&
            time === new Date(res.start_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        );
    }

    function isSameMinute(date1, timeStr) {
        return date1.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) === timeStr;
    }

    function showReservationDetails(resId) {
        const reservation = reservations.find(res => res.id === resId);
        if (reservation) {
            document.getElementById('resName').textContent = reservation.guest__name;
            document.getElementById('resTables').textContent = reservation.tables__number;
            const startTime = new Date(reservation.start_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const endTime = new Date(reservation.end_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('resTime').textContent = `${startTime} - ${endTime}`;
            document.getElementById('reservationModal').style.display = 'block';
        }
    }

    function closeModal() {
        document.getElementById('reservationModal').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Open the modal when the Calendar button is clicked
        const calendarButton = document.querySelector('.calendar-action');
        const calendarModal = document.getElementById('calendarModal');
        const closeModalButton = document.querySelector('.close');

        calendarButton.addEventListener('click', function () {
            calendarModal.style.display = 'block'; // Show the modal
        });

        // Close the modal when the "x" button is clicked
        closeModalButton.addEventListener('click', function () {
            calendarModal.style.display = 'none'; // Hide the modal
        });

        // Close the modal when clicking outside the modal content
        window.addEventListener('click', function (event) {
            if (event.target == calendarModal) {
                calendarModal.style.display = 'none';
            }
        });

        // Handle navigation between months
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        let currentDate = new Date();

        function renderCalendar() {
            const monthYearDisplay = document.getElementById('calendarMonthYear');
            const calendarDays = document.getElementById('calendarTable');
            
            // Clear previous calendar days
            calendarDays.innerHTML = '';

            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            // Display the current month and year
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            monthYearDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Get the first day of the month
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();

            // Get the number of days in the current month
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // Add blank cells for days before the first of the month
            for (let i = 0; i < firstDay; i++) {
                const blankCell = document.createElement('td');
                calendarDays.appendChild(blankCell);
            }

            // Add the days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('td');
                dayCell.textContent = day;
                dayCell.addEventListener('click', function () {
                    alert(`You selected ${day} ${monthNames[currentMonth]} ${currentYear}`);
                });
                calendarDays.appendChild(dayCell);

                // Start a new row after every 7th day (i.e., end of the week)
                if ((day + firstDay) % 7 === 0) {
                    const row = document.createElement('tr');
                    calendarDays.appendChild(row);
                }
            }
        }

        // Navigate to the previous month
        prevMonthButton.addEventListener('click', function () {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        // Navigate to the next month
        nextMonthButton.addEventListener('click', function () {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        // Initial render of the calendar
        renderCalendar();
    });
</script>

</body>
</html>
